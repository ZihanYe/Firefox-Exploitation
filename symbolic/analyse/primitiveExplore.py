import angr
from colorama import Fore, Back, Style
from tabulate import tabulate

class PrimitiveExplore:
    def __init__(self, project, simgr, write_primitive = [], control_hijack=[]):
        self.write_primitive = write_primitive
        self.control_hijack = control_hijack
        self.simgr = simgr
        self.proj = project
        self.listmap = {
            'W': self.write_primitive,
            'C': self.control_hijack,
            'A': self.simgr.active,
            'F': self.simgr.found,
            'U': self.simgr.unconstrained,
            'E': self.simgr.errored,
        }

    def dump_stats(self):
        print("State stats:")
        print('*' * 100)
        table = []
        table.append(["write primitive (W)", len(self.listmap['W'])])
        table.append(["control_hijack (C)", len(self.listmap['C'])])
        table.append(["active (A)", len(self.listmap['A'])])
        table.append(["found (F)", len(self.listmap['F'])])
        table.append(["unconstrained (U)", len(self.listmap['U'])])
        table.append(["errored (E)", len(self.listmap['E'])])
        print(tabulate(table, headers=["Type", "Count"]))

    def sort_by_obj_count(self, type='W'):
        if type not in self.listmap:
            print(Fore.RED + "[-] Please specify the correct type" + Style.RESET_ALL)
            return

        def count_obj(s):
            return len(s.record.obj_mem)
        self.listmap[type].sort(key=count_obj)

    def sort_by_constraints(self,type='W'):
        if type not in self.listmap:
            print(Fore.RED + "[-] Please specify the correct type" + Style.RESET_ALL)
            return
        def count_constraints(s):
            return len(s.solver.constraints)
        self.listmap[type].sort(key=count_constraints)

    def get_states(self, type='W', limit = 5):
        if type not in self.listmap:
            print(Fore.RED + "[-] Please specify the correct type" + Style.RESET_ALL)
            return

        n = min(len(self.listmap[type]), limit)
        return self.listmap[type][:n]

    def prune_write_primitive(self):
        map = {}
        for w in self.listmap[type]:
            if w.addr in lst:
                map[w.addr].append(w)
            else:
                map[w.addr] = [w]

        def primitive_complexity(s):
            return len(s.obj_mem) + len(s.sym_call_ret_values)

        lst = []
        for addr in map:
            ps = map[addr]
            ps.sort(key=primitive_complexity)
            lst.append(ps[0])
        return lst
