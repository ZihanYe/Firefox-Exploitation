import angr
import logging
log = logging.getLogger("symbolic")

class LimitedDepth(angr.SimProcedure):
    NO_RET = False
    IS_FUNCTION = True

    def run(self):
        try:
            # index = len(self.state.record.depth_limited_var)
            # ret_symbol = self.state.solver.BVS("depth_limited_"+ str(index), size=64, explicit_name=True)
            ret_symbol = self.state.checkpoint.ret_symbol
            self.state.record.add_depth_limited(self.state.callstack.call_site_addr, ret_symbol)
            ret_v = self.ret(expr=ret_symbol, index=index)
            # self.state.record.add_depth_limited(self.state.history.parent.addr, ret_symbol)
        except:
            log.error("[-] WARNING depth limited symbolic return failed unexpectedly")
