from . import SimConcretizationStrategy

class SimConcretizationStrategyTaintRange(SimConcretizationStrategy):
    '''
    Concretization that return address in a list of memory region
    and possibly a random address
    '''
    def __init__(self, tainted_mem, new_addr=False, limit=64, **kwargs):
        super(SimConcretizationStrategyTaint, self).__init__(**kwargs)
        self._tainted_mem = tainted_mem # memory address that are pointed by a controlled memory location
        self._limit = limit
        self.new_addr = new_addr

    def _concretize(self, memory, addr):
        addrs = []
        if self.new_addr:
            freshAddr = self._any(memory,addr)
            if freshAddr != None:
                print("randomly an address: ", freshAddr)
                addrs.append(freshAddr)

        choices = []
        for r in self._tainted_mem:
            choices.append((r, addr))

        def inside(x, range):
            return x > range._1 and x < range._2

        constraint = memory.state.solver.Or(*[ inside(x, range) for (x,range) in choices])
        memory.state.add_constraints(constraint)
        print("using taint strategy")
        try:
            addrs.extend(self._eval(memory, addr, self._limit))
        except:
            addrs = addrs
        return addrs
