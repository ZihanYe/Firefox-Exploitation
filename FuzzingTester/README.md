# Firefox exploitation generation

## Automated tester

Given a large number of test cases generated by fuzzer, we want to test each of them against a firefox build. For those that lead to a crash, we note done the stack trace at the point of crash

FuzzingTester contains implementation that does the job. How it is done depends on how Firefox is build.

### prerequisite

Python version >= 3.6

All prerequisite needed for building Firefox, see [Firefox build tutorial](https://developer.mozilla.org/en-US/docs/Mozilla/Developer_guide/Build_Instructions)

### Set-up

### 1. Build Firefox

**1.1 Get source** 

In the case of exploitation generation, you may want a specific version in which a vulnerability occurs. You can find the version you want and get the source code from https://ftp.mozilla.org/pub/firefox/releases/

**1.2 Configuration**

See [Mozilla tutorial](https://developer.mozilla.org/en-US/docs/Mozilla/Developer_guide/Build_Instructions/Configuring_Build_Options) for configuring the build using mozconfig.

For working with fuzzer, you need to add
```
ac_add_options --enable-fuzzing
```

For working with our test runner, you need either:

- build with crash reporter enabled (a lot faster and recommanded)

	add to mozconfig:

	```
	ac_add_options --disable-jemalloc
	ac_add_options --enable-crashreporter
	```

	An example mozconfig I used can be find in ```resource``` folder.

- debug build

	add to mozconfig:
	```
	ac_add_options --enable-debug
	```

**1.3 Build!**

For errors encounted during build, there is a list of [trouble shooting solutions](https://github.com/ZihanYe/Firefox-Exploitation/tree/master/Manual%20Exploitation) that might help.

### 2. Set up FuzzingTester

**2.1 Get source**

```
git clone https://github.com/ZihanYe/Firefox-Exploitation.git
cd Firefox-Exploitation/FuzzingTester/
export TESTER_WORKDIR=/path/to/Firefox-Exploitation/FuzzingTester/
```

Depending on which Firefox build you have:

- If you have a firefox build with crash reporter enabled, FuzzingTester provides script to run each test and produce a minidump file at the point of crash, then minidump is parsed using **minidump-stackwalker**

- If you are going to use gdb only with a firefox debug build, skip step 2.2 and 2.3 below


**2.2 Breakpad**

Download Google Breakpad following [this](https://chromium.googlesource.com/breakpad/breakpad/) OR the following commands:
```
git clone https://chromium.googlesource.com/breakpad/breakpad
cd breakpad
./configure && make
```
If you get error ``` third_party/lss/linux_syscall_support.h: No such file or directory```, run

```
git clone https://chromium.googlesource.com/linux-syscall-support src/third_party/lss
./configure && make
```

Finally generate symbol of firefox following steps in [here](https://chromium.googlesource.com/breakpad/breakpad/+/master/docs/linux_starter_guide.md)

In summary,
```
/path/to/breakpad/src/tools/linux/dump_syms/dump_syms ./path/to/your/firefox/binary > firefox.sym
head -n1 firefox.sym
```

The last command gives a long hash. Copy the hash (refered as <HASH> from now on)

```
mkdir -p ./symbols/firefox/<HASH>
mv firefox.sym ./symbols/firefox/<HASH>
```

Now you have symbol for firefox --- ```./symbols```, and ```minidump_stackwalk``` that comes with breakpad --- ```/path/to/your/breakpad/src/processor/minidump_stackwalk```. We need to provide these two via environment variable in step 2.4 (or arguments to the python script)

**2.3 Set up mozbase**

Mozilla provides ```mozbase```, a collection of useful python scripts. To build it, firstly find ```mozbase``` in your Firefox build. It might be specific to different versions. For example, in Firefox-63.0.3, it is ./objdir-ff-dbg/\_tests/mozbase/

We also need to set up virtual environment.

A script is written that does all the set-up job.

Just run:

```
source setup.sh
```

**2.4 Set up environment**

open ```init.sh```, change environment variables according to your firefox build.

run:

```
source init.sh
```

### Usage

- If you have a firefox build with crash reporter enabled, use ```minidumpCollector.py``` to test all your test cases:

```
usage: minidumpCollector.py [-h] [--firefox FIREFOX]
                            [--stackwalk_binary STACKWALK_BINARY]
                            [--symbol_path SYMBOL_PATH]
                            [--template_profile TEMPLATE_PROFILE]
                            [--trace_only] [--timeout TIMEOUT]
                            [--firefox_args [FIREFOX_ARGS [FIREFOX_ARGS ...]]]
                            tests out_dir

positional arguments:
  tests                 path to directory containing all tests to run, OR path
                        to a single file
  out_dir               path to output directory

optional arguments:
  -h, --help            show this help message and exit
  --firefox FIREFOX     path to firefox binary; if not specified, must be set
                        in TESTER_FIREFOX environment variable
  --stackwalk_binary STACKWALK_BINARY
                        path to minidump_stackwalker; if not specified, must
                        be set in TESTER_STACKWALKER environment variable
  --symbol_path SYMBOL_PATH
                        path to symbol for firefox
  --template_profile TEMPLATE_PROFILE
                        path to directory used as template for profile
  --trace_only          store only stack trace (no register values, stack
                        content etc
  --timeout TIMEOUT     maximum time allowed for running firefox before
                        shutting down
  --firefox_args [FIREFOX_ARGS [FIREFOX_ARGS ...]]
                        additional arguments to firefox (without -)

```

- otherwise, with gdb, use ```gdbTestRunner.py```, although it is much slower:

```
usage: gdbTestRunner.py [-h] [--firefox FIREFOX]
                        [--template_profile TEMPLATE_PROFILE]
                        [--timeout TIMEOUT]
                        [--firefox_args [FIREFOX_ARGS [FIREFOX_ARGS ...]]]
                        tests out_dir

positional arguments:
  tests                 path to directory containing all tests to run, OR path
                        to a single file
  out_dir               path to output directory

optional arguments:
  -h, --help            show this help message and exit
  --firefox FIREFOX     path to firefox binary; if not specified, must be set
                        in TESTER_FIREFOX environment variable
  --template_profile TEMPLATE_PROFILE
                        path to directory used as template for profile
  --timeout TIMEOUT     maximum time allowed for running firefox before
                        shutting down
  --firefox_args [FIREFOX_ARGS [FIREFOX_ARGS ...]]
                        additional arguments to firefox (without -)

```

```filter.py``` can take crashing stack trace of the original Poc and crashing traces of tests, compare them and find out all test cases that crashed at a different location.

Crash of Poc and test cases can be generated seperately uding ```minidumpCollector.py``` or ```gdbTestRunner.py```, while all jobs can be done in a pipeline by ```filter.py```.

```
usage: filter.py [-h] [--poc POC] [--poc_crash POC_CRASH]
                 [--test_crashes TEST_CRASHES] [--firefox FIREFOX]
                 [--use_minidump] [--stackwalk_binary STACKWALK_BINARY]
                 [--symbol_path SYMBOL_PATH]
                 [--template_profile TEMPLATE_PROFILE] [--log_tests]
                 [--timeout TIMEOUT]
                 [--firefox_args [FIREFOX_ARGS [FIREFOX_ARGS ...]]]
                 tests out_dir

positional arguments:
  tests                 path to directory containing all tests to run
  out_dir               path to output directory

optional arguments:
  -h, --help            show this help message and exit
  --poc POC             path to Poc file
  --poc_crash POC_CRASH
                        path to crashing trace of Poc;
  --test_crashes TEST_CRASHES
                        path to diretory containing crashing traces of tests
  --firefox FIREFOX     path to firefox binary; if not specified, must be set
                        in TESTER_FIREFOX environment variable
  --use_minidump        use minidump instead of gdb (require stackwalk_binary
  --stackwalk_binary STACKWALK_BINARY
                        path to minidump_stackwalker; if not specified, must
                        be set in TESTER_STACKWALKER environment variable
  --symbol_path SYMBOL_PATH
                        path to symbol for firefox
  --template_profile TEMPLATE_PROFILE
                        path to directory used as template for profile
  --log_tests           log test names instead of copy over
  --timeout TIMEOUT     maximum time allowed for running firefox before
                        shutting down
  --firefox_args [FIREFOX_ARGS [FIREFOX_ARGS ...]]
                        additional arguments to firefox (without -)

```

### resources:

- [Mozbase](https://firefox-source-docs.mozilla.org/mozbase/)

- [Mozbase usage](https://wiki.mozilla.org/Auto-tools/Projects/Mozbase)

- [Decoding minidumps](http://www.chromium.org/developers/decoding-crash-dumps)

- [Mozilla: debugging a minidump](https://developer.mozilla.org/en-US/docs/Mozilla/Debugging/Debugging_a_minidump)




