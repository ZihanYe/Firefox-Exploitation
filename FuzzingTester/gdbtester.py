import gdb
import os

def event_handler(event):
	gdb.execute("set logging file " + logfile)
	gdb.execute("set logging redirect on")
	gdb.execute("set logging on")
	gdb.write("\n[CRASH] SIG " + event.stop_signal + "\n")
	gdb.execute("bt 10")
	gdb.execute("set logging off")
	gdb.execute("q")


testcase = os.environ['TESTER_TESTCASE']
logfile = os.environ['TESTER_LOGFILE']
prefdir = os.environ['TESTER_PREFDIR']

if testcase is None:
	raise Exception("test cases directory should be specified")
if logfile is None:
	raise Exception("Log file should be specified")

cmd = "set args -no-remote -headless"
if prefdir is not None:
	cmd += " --profile " + prefdir

cmd += " file://" + testcase
gdb.execute(cmd)
gdb.events.stop.connect(event_handler)
gdb.execute("set disable-randomization off")
gdb.execute("set confirm off")
gdb.execute("set pagination off")
gdb.execute("run")
