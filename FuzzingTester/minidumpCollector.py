import os
import subprocess
import sys
import tempfile
import shutil
from helper import (create_profile, get_log_file, test_crashed)
from minidumpParser import (parse_minidump)

__all__ = ['run_tests', 'run_test']

def run_test(firefox, test, profile=None, timeout=20, ffargs=[]):
	if not test.endswith('.html'):
			raise Exception("[run_test] test is not a HTML file")
	fileUrl = "file://" + test

	# call firefox
	print("================== Testing with exploitation:" + test)
	cmd = firefox + " --no-remote --headless "
	if profile != None:
		cmd += "--profile " + os.path.abspath(profile) + " "
	for a in ffargs:
		cmd += "--" + a + " "
	cmd += fileUrl

	print("================== Executing Command: " + cmd)
	timedout = False
	jsError = False
	proc = subprocess.Popen(cmd.split(), stdout=subprocess.PIPE, stderr=subprocess.PIPE)
	try:
	    outs, errs = proc.communicate(timeout=timeout)
	except subprocess.TimeoutExpired:
	    proc.kill()
	    timedout = True
	    print("================== timeout, process killed")
	    outs, errs = proc.communicate()
	    # check javascript error
	    jsError = errs.decode('utf-8', "backslashreplace").find("JavaScript error: " + fileUrl) > -1
	return outs, errs, timedout, jsError

def run_tests(firefox, tests, outdir, stackwalker, symbolPath=None, templateProfile=None, timeout=20, traceOnly=False, ffargs=[]):
	try:
		WORKDIR = os.environ.get('TESTER_WORKDIR')
	except:
		raise Exception("No environment variable: TESTER_WORKDIR")

	try:
		MOZCRASH = os.environ.get('TESTER_MOZCRASH')
	except:
		raise Exception("No environment variable: TESTER_MOZCRASH")

	# validation
	if not os.path.isfile(firefox):
		raise Exception("Firefox binary: No such file: " + firefox)
	if not os.path.isdir(tests):
		raise Exception("Test directory: No such directory: "+ tests)
	if not os.path.isdir(outdir):
		raise Exception("Output directory: No such directory: "+ outdir)
	if not os.path.isfile(stackwalker):
		raise Exception("minidump_stackwalker: No such file: "+ stackwalker)

	if templateProfile == None:
		templateProfile = os.path.join(WORKDIR, "profile")
	elif not os.path.isdir(templateProfile):
		raise Exception("Profile directory: No such directory: "+ profile)

	# create tmp working sub-directory
	tempworkingdir = tempfile.mkdtemp(prefix="run_")

	prefdir = os.path.join(tempworkingdir, "pref")
	if not os.path.isdir(prefdir):
		os.makedirs(prefdir)
	print("save pref under directory " + prefdir)

	allfiles = os.listdir(tests)
	testcases = list(filter(lambda f: f.endswith('.html'),allfiles))
	nofiles = len(testcases)
	print(str(nofiles) + " to test")
	count = 0

	timeoutlogPath = os.path.join(outdir, "timeoutTests.txt")
	if os.path.isfile(timeoutlogPath):
		timeoutlog = open(timeoutlogPath, "r")
		content = timeoutlog.read()
		timeoutlog.close()
		timedoutfiles = content.split('\n')
	else:
		timedoutfiles = []

	# timeout test cases log:
	timeoutlog = open(timeoutlogPath, "a")
	# test cases that contained js error:
	jsErrlogPath = os.path.join(outdir, "jsErrorTests.txt")
	jsErrlog = open(jsErrlogPath, "a")
	# parsing minidump failed
	parsingErrlogPath = os.path.join(outdir, "minidumpErr.txt")
	parsingErrlog = open(parsingErrlogPath, "a")
	# nocrash test case:
	nocrashlogPath = os.path.join(outdir, "nocrashTests.txt")
	nocrashlog = open(nocrashlogPath, "a")
	for file in testcases:
		if file in timedoutfiles:
			continue
		logfile = get_log_file(file, outdir)
		if (os.path.isfile(logfile)):
			count += 1
			print("========== output of "+ file + " exits, skipping...")
			continue
		# create profile
		profile = create_profile(template=templateProfile, tmpdir=prefdir)

		outs, errs, timedout, jsError = run_test(firefox, os.path.abspath(os.path.join(tests, file)), profile, timeout, ffargs)
		# print("========== ERROR: \n" + errs.decode('utf-8', "backslashreplace"))
		if timedout:
			timeoutlog.write(file + "\n")
		if jsError:
			jsErrlog.write(file+ "\n")
		dumpDirectory = os.path.abspath(os.path.join(profile, "minidumps"))
		crashed = test_crashed(file, usedMinidump=True, profile=profile)
		if not crashed:
			print("================ no crash reported when testing "+ file)
			nocrashlog.write(file + " \n")
		else:
			# minidump
			if symbolPath == None:
				symbolPath = os.path.abspath(firefox)
			getTrace, trace = parse_minidump(MOZCRASH, dumpDirectory, stackwalker, symbolPath, traceOnly, timeout)
			if not getTrace:
				parsingErrlog.write(file + " \n")
			else:
				f = open(logfile, "w")
				f.write(trace)
				f.close()

		# remove temp profile
		shutil.rmtree(profile, True)
		count += 1
		print(str(count) + "/" + str(nofiles) + " done.")

	timeoutlog.close()
	nocrashlog.close()
	jsErrlog.close()
	parsingErrlog.close()
	shutil.rmtree(tempworkingdir, True)
	print("DONE testing all HTML files in " + tests)
	return timeoutlogPath, jsErrlogPath, parsingErrlogPath, nocrashlogPath

if __name__ == '__main__':
	import argparse
	parser = argparse.ArgumentParser()
	parser.add_argument('tests', help="path to directory containing all tests to run, OR path to a single file")
	parser.add_argument('out_dir', help="path to output directory")
	parser.add_argument('--firefox', help="path to firefox binary; if not specified, must be set in TESTER_FIREFOX environment variable")
	parser.add_argument('--stackwalk_binary', help="path to minidump_stackwalker; if not specified, must be set in TESTER_STACKWALKER environment variable")
	parser.add_argument('--symbol_path', help="path to symbol for firefox")
	parser.add_argument('--template_profile', help="path to directory used as template for profile")
	parser.add_argument('--trace_only', action='store_true', help="store only stack trace (no register values, stack content etc")
	parser.add_argument('--timeout', type=int, help="maximum time allowed for running firefox before shutting down", default=20)
	parser.add_argument('--firefox_args', nargs='*', help="additional arguments to firefox (without -)", default=[])
	args = parser.parse_args()

	firefox = args.firefox
	if firefox == None:
		try:
			firefox = os.environ.get('TESTER_FIREFOX')
		except:
			raise Exception("must set TESTER_FIREFOX environment variable or pass in via argument")

	stackwalker = args.stackwalk_binary
	if stackwalker == None:
		try:
			stackwalker = os.environ.get('TESTER_STACKWALKER')
		except:
			raise Exception("must set TESTER_STACKWALKER environment variable or pass in via argument")

	symbolpath = args.symbol_path
	if symbolpath == None:
		try:
			symbolpath = os.environ.get('TESTER_SYMBOLPATH')
		except:
			symbolpath = None

	tests = args.tests
	tempdir = None
	if os.path.isfile(tests):
		# make a temp directory containing only one test
		# create tmp working sub-directory
		tempdir = tempfile.mkdtemp(prefix="testcase_")
		shutil.copyfile(tests, os.path.join(tempdir, os.path.basename(tests)))
		tests = tempdir

	run_tests(firefox, tests, args.out_dir, stackwalker, symbolPath=symbolpath,
              templateProfile=args.template_profile,
              timeout=args.timeout, traceOnly=args.trace_only,
              ffargs=args.firefox_args)

	if tempdir != None:
		shutil.rmtree(tempdir, True)
