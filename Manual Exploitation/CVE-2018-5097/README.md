# CVE-2018-5097

heap-use-after-free in txNameTest::matches

## Firefox

I tested this vulnerability with Firefox 56.0 ASAN build downloaded from [here](https://ftp.mozilla.org/pub/firefox/releases/56.0/source/).

To build it, I had to downgrade my rust to 1.19.0 according to [Firefox's Rust Update policy](https://wiki.mozilla.org/Rust_Update_Policy_for_Firefox).

In order for making Firefox opening the PoC file without any other disruption, I used some customized preferences. Preferences can be set in ```about:config``` page in Firefox by searching for preferences listed in [user.js](https://github.com/ZihanYe/Firefox-Exploitation/blob/master/Manual%20Exploitation/CVE-2017-7828/user.js), or if you are running Firefox in headless mode (```--headless```), then create a new profile like this:

```
mkdir -p /path/to/firefox/build/directory/tmp/customized_profile
```
and move [user.js]() under the new profile folder.

Run firefox with options ```--headless --no-remote --profile /path/to/the/profile/folder/just/created file:///path/to/crash.html```


## PoC

From the ASAN report, the freed object is an nsTextNode, allocated in

```
nsXMLContentSink::FlushText(bool) /home/ug16zy2/firefox-56.0/dom/xml/nsXMLContentSink.cpp:772
```

Setting breakpoints on ``` nsTextNode::~nsTextNode()```, we can see a sequence of text nodes being freed.

Then ```txMozillaXSLTProcessor::TransformToDoc(nsIDOMDocument**, bool) in ./dom/xslt/xslt/txMozillaXSLTProcessor.cpp``` is invoked at some point. Inside this function:

```
txExecutionState es(mStylesheet, IsLoadDisabled());
nsresult rv = es.init(*sourceNode, &mVariables);
```

a ```txExecutionState``` is created, which has a pointer ```(txNodeSetContext*) mEvalContext``` to a ```txNodeSetContext```, which then has a pointer ```(RefPtr<txNodeSet>) mContextSet``` referencing a ```txNodeSet```. ```mContextSet``` has a pointer (**dangling pointer**) to the freed text node.

Then ```txXSLTProcessor``` is executed and it tries to apply templates on each items in ```txNodeSet```, which dereferences the dangling pointer at some point, for example:

```
    #6 0x7fe8711b3514 in txStylesheet::findTemplate(txXPathNode const&, txExpandedName const&, txIMatchContext*, txStylesheet::ImportFrame*, txInstruction**, txStylesheet::ImportFrame**) /home/worker/workspace/build/src/dom/xslt/xslt/txStylesheet.cpp:133:45
    #7 0x7fe87117045a in txApplyTemplates::execute(txExecutionState&) /home/worker/workspace/build/src/dom/xslt/xslt/txInstructions.cpp:85:26
    #8 0x7fe8711d347d in txXSLTProcessor::execute(txExecutionState&) /home/worker/workspace/build/src/dom/xslt/xslt/txXSLTProcessor.cpp:49:21
    #9 0x7fe87119ce9a in txMozillaXSLTProcessor::TransformToDoc(nsIDOMDocument**, bool) 
```
